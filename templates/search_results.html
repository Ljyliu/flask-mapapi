{% extends "base.html" %}

{% block title %}
    搜索客户-客户地图系统
{% endblock %}


{% block content %}  
    <h2>
        搜索客户
        {% if keyword %}
            搜索结果: "{{ keyword }}" （找到 {{ count }} 个客户）
        {% else %}
            列表所有客户（共 {{ count }} 个）
        {% endif %}
    </h2>

    <div class="mb-3"> 
        <form action="{{ url_for('map.search') }}" method="GET" class="g-3 mb-4">
            <label for="keyword">搜索:</label>
            <input type="text" name="keyword" id="keyword" class="form-control-sm" placeholder="请输入姓名或电话">
            <button type="submit" class="btn btn-primary">确认</button>
            <div class="col-auto">
                <a href="{{ url_for('map.list_customers') }}" class="btn btn-outline-secondary">返回列表</a>
            </div>
        </form>
    </div>

    {% if customers_data %}
    <table class="table table-striped table-hover"> 
        <thead>
            <tr>
                <th>编号</th>
                <th>姓名</th>
                <th>电话</th>
                <th>地址</th>
                <th>操作</th>
            </tr>
        </thead>

        <tbody>
            {% for item in customers_data %}
                <tr>
                    <td>{{ item.index }}</td>
                    <td>{{ item.customer.name }}</td>
                    <td>{{ item.customer.phone or '' }}</td>
                    <td>{{ item.customer.address }}</td>
                    <td>
                        <a href="{{ url_for('map.update_customer',customer_id=item.customer.id) }}" class="btn btn-sm btn-outline-primary">编辑</a>
                        <form action="{{url_for('map.delete',customer_id=item.customer.id)}}" method="POST" style="display:inline-block;">
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirmDelete('{{ item.customer.name }}')">删除</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

        <div id="container" style="width: 100%; height: 600px;"></div>
    <script src="https://webapi.amap.com/loader.js"></script>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "{{ s_code }}",
        };
        
        (function initMap() {
            AMapLoader.load({
                key: "{{ web_key }}",
                version: "2.0",
                plugins: ["AMap.Scale"],
            })
            .then((AMap) => {
                // 获取客户数据
                const customersData = JSON.parse('{{ customers_data|tojson|safe }}');
                
                // 设置默认中心点
                let center = [116.397428, 39.90923];
                let zoom = 10;

                // 查找第一个有坐标的客户作为中心点
                for (let i = 0; i < customersData.length; i++) {
                    let customer = customersData[i].customer;
                    if (customer.latitude && customer.longitude) {
                        center = [customer.longitude, customer.latitude];
                        zoom = 15;
                        break;
                    }
                }

                // 创建地图实例
                var map = new AMap.Map("container", {
                    zoom: zoom,
                    center: center
                });

                // 添加比例尺控件
                map.addControl(new AMap.Scale());

                // 添加客户标记
                customersData.forEach(function(item) {
                    if (item.customer.latitude && item.customer.longitude) {
                        var marker = new AMap.Marker({
                            position: [item.customer.longitude, item.customer.latitude],
                            title: item.customer.name,
                            map: map
                        });

                        var infoWindow = new AMap.InfoWindow({
                            content: "<div><strong>" + item.customer.name + "</strong><br/>" +
                                    "电话: " + (item.customer.phone || '无') + "<br/>" +
                                    "地址: " + item.customer.address + "</div>"
                        });

                        marker.on('click', function(e) {
                            infoWindow.open(map, e.target.getPosition());
                        });
                    }
                });
            })
            .catch((e) => {
                console.error(e);
            });
        })();
    </script>





    {% else %}
        <div class="alert alert-warning">没有找到匹配的客户</div>
    {% endif %}
{% endblock %}

