{% extends "base.html" %}

{% block title %}
    æœç´¢å®¢æˆ·-å®¢æˆ·åœ°å›¾ç³»ç»Ÿ
{% endblock %}


{% block content %}  
    <style>
        #container {
            width: 100%;
            height: 600px;  /* ç”µè„‘ä¸Š600px */
        }
        
        @media (max-width: 768px) {
            #container {
                height: 300px;  /* æ‰‹æœºä¸Š300px */
            }
        }
    </style>


    <h2>
        æœç´¢å®¢æˆ·
        {% if keyword %}
            æœç´¢ç»“æœ: "{{ keyword }}" ï¼ˆæ‰¾åˆ° {{ count }} ä¸ªå®¢æˆ·ï¼‰
        {% else %}
            åˆ—è¡¨æ‰€æœ‰å®¢æˆ·ï¼ˆå…± {{ count }} ä¸ªï¼‰
        {% endif %}
    </h2>

    <div class="mb-3"> 
        <form action="{{ url_for('map.search') }}" method="GET" class="g-3 mb-4">
            <label for="keyword">æœç´¢:</label>
            <input type="text" name="keyword" id="keyword" class="form-control-sm" placeholder="è¯·è¾“å…¥å§“åæˆ–ç”µè¯">
            <button type="submit" class="btn btn-primary">ç¡®è®¤</button>
            <div class="col-auto">
                <a href="{{ url_for('map.list_customers') }}" class="btn btn-outline-secondary">è¿”å›åˆ—è¡¨</a>
            </div>
        </form>
    </div>

    {% if customers_data %}
    <table class="table table-striped table-hover"> 
        <thead>
            <tr>
                <th>ç¼–å·</th>
                <th>å§“å</th>
                <th>ç”µè¯</th>
                <th>åœ°å€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>

        <tbody>
            {% for item in customers_data %}
                <tr>
                    <td>{{ item.index }}</td>
                    <td>{{ item.customer.name }}</td>
                    <td>{{ item.customer.phone or '' }}</td>
                    <td>{{ item.customer.address }}</td>
                    <td>
                        <a href="{{ url_for('map.update_customer',customer_id=item.customer.id) }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                        <form action="{{url_for('map.delete',customer_id=item.customer.id)}}" method="POST" style="display:inline-block;">
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirmDelete('{{ item.customer.name }}')">åˆ é™¤</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

        <div id="container"></div>
    <script src="https://webapi.amap.com/loader.js"></script>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "{{ s_code }}",
        };
        
        (function initMap() {
            AMapLoader.load({
                key: "{{ web_key }}",
                version: "2.0",
                plugins: ["AMap.Scale"],
            })
            .then((AMap) => {
                // è·å–å®¢æˆ·æ•°æ®
                const customersData = JSON.parse('{{ customers_data|tojson|safe }}');
                
                // è®¾ç½®é»˜è®¤ä¸­å¿ƒç‚¹
                let center = [116.397428, 39.90923];
                let zoom = 10;

                // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰åæ ‡çš„å®¢æˆ·ä½œä¸ºä¸­å¿ƒç‚¹
                for (let i = 0; i < customersData.length; i++) {
                    let customer = customersData[i].customer;
                    if (customer.latitude && customer.longitude) {
                        center = [customer.longitude, customer.latitude];
                        zoom = 15;
                        break;
                    }
                }

                // åˆ›å»ºåœ°å›¾å®ä¾‹
                var map = new AMap.Map("container", {
                    zoom: zoom,
                    center: center
                });

                // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶
                map.addControl(new AMap.Scale());

                // æ·»åŠ å®¢æˆ·æ ‡è®°
                customersData.forEach(function(item) {
                    if (item.customer.latitude && item.customer.longitude) {
                        var marker = new AMap.Marker({
                            position: [item.customer.longitude, item.customer.latitude],
                            title: item.customer.name,
                            map: map
                        });

                            var infoContent = `
                                <div style="padding: 12px; min-width: 180px;">
                                    <h4 style="margin:0 0 5px 0; color:#1890ff;">${item.customer.name}</h4>
                                    <p style="margin:5px 0; color:#666; font-size:13px;">ç”µè¯: ${item.customer.phone || 'æ— '}</p>
                                    <p style="margin:5px 0; color:#666; font-size:13px;">${item.customer.address}</p>
                                    <button onclick="navigateToMap(${item.customer.longitude}, ${item.customer.latitude}, '${item.customer.name}')" 
                                            style="width:100%; margin-top:8px; padding:8px; background:#1890ff; color:white; border:none; border-radius:4px; font-size:14px; cursor:pointer;">
                                        ğŸš— å»è¿™é‡Œ
                                    </button>
                                </div>
                            `;
                            var infoWindow = new AMap.InfoWindow({
                                content: infoContent,
                                offset: new AMap.Pixel(0, -30)
                            });

                        marker.on('click', function(e) {
                            infoWindow.open(map, e.target.getPosition());
                        });
                    }
                });
            })
            .catch((e) => {
                console.error(e);
            });
        })();

    // ========== å¯¼èˆªåŠŸèƒ½ï¼šè‡ªåŠ¨è¯†åˆ«è®¾å¤‡ ==========
    function navigateToMap(lng, lat, name) {
        // æç¤ºå¼¹çª—
        alert('æ­£åœ¨æ‰“å¼€åœ°å›¾ï¼Œå¦‚è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œè¯·ç‚¹å‡»åœ°å€æ å…è®¸å¼¹çª—...');

        const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
        const encodedName = encodeURIComponent(name);
        
        if (isMobile) {
            // æ‰‹æœºç«¯ï¼šç³»ç»Ÿé€‰æ‹©å™¨
            window.location.href = `geo:${lat},${lng}?q=${lat},${lng}(${encodedName})`;
            setTimeout(() => {
                window.open(`https://uri.amap.com/marker?position=${lng},${lat}&name=${encodedName}`, '_blank');
            }, 1000);
        } else {
            // ç”µè„‘ç«¯ï¼šå¼¹ä¸ªç®€å•é€‰æ‹©
            const choice = confirm(`ç”¨å“ªä¸ªåœ°å›¾æŸ¥çœ‹ ${name}ï¼Ÿ\nç¡®å®š=é«˜å¾·åœ°å›¾ï¼Œå–æ¶ˆ=ç™¾åº¦åœ°å›¾`);
            if (choice) {
                window.open(`https://uri.amap.com/marker?position=${lng},${lat}&name=${encodedName}`, '_blank');
            } else {
                window.open(`https://map.baidu.com/?latlng=${lat},${lng}&title=${encodedName}`, '_blank');
            }
        }
    }


    </script>


    {% else %}
        <div class="alert alert-warning">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å®¢æˆ·</div>
    {% endif %}
{% endblock %}

