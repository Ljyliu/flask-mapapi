{% extends "base.html" %}

{% block title %}
    é¦–é¡µ-å®¢æˆ·åœ°å›¾ç³»ç»Ÿ
{% endblock %}

{% block content %}
<style>
    #container {
        width: 100%;
        height: 800px;  /* ç”µè„‘æ ·å¼ */
    }
    
    @media (max-width: 768px) {
        #container {
            height: 350px;  /* æ‰‹æœºæ ·å¼ */
        }
    }
</style>
<div id="container"></div>
<script src="https://webapi.amap.com/loader.js"></script>
<script type="text/javascript">
    window._AMapSecurityConfig = {
        securityJsCode: "{{ s_code }}",
    };
    AMapLoader.load({
        key: "{{ web_key }}", //ç”³è¯·å¥½çš„ Web ç«¯å¼€å‘ Keyï¼Œé¦–æ¬¡è°ƒç”¨ load æ—¶å¿…å¡«
        version: "2.0", //æŒ‡å®šè¦åŠ è½½çš„ JS API çš„ç‰ˆæœ¬ï¼Œç¼ºçœæ—¶é»˜è®¤ä¸º 1.4.15
        plugins: ["AMap.Scale","AMap.Marker","AMap.InfoWindow"], //éœ€è¦ä½¿ç”¨çš„çš„æ’ä»¶åˆ—è¡¨ï¼Œå¦‚æ¯”ä¾‹å°º'AMap.Scale'ï¼Œæ”¯æŒæ·»åŠ å¤šä¸ªå¦‚ï¼š['AMap.Scale','...','...']
        AMapUI: {
        //æ˜¯å¦åŠ è½½ AMapUIï¼Œç¼ºçœä¸åŠ è½½
            version: "1.1", //AMapUI ç‰ˆæœ¬
            plugins: ["overlay/SimpleMarker"], //éœ€è¦åŠ è½½çš„ AMapUI ui æ’ä»¶
        },
        Loca: {
        //æ˜¯å¦åŠ è½½ Locaï¼Œ ç¼ºçœä¸åŠ è½½
            version: "2.0", //Loca ç‰ˆæœ¬
        },
    })
    .then((AMap) => {
        var map = new AMap.Map("container"); //"container"ä¸º <div> å®¹å™¨çš„ id
        map.addControl(new AMap.Scale()); //æ·»åŠ æ¯”ä¾‹å°ºç»„ä»¶åˆ°åœ°å›¾å®ä¾‹ä¸Š
        fetch("{{ url_for('map.customers_data') }}")
            .then(response => response.json())
            .then(customers => {
                customers.forEach(customer => { 
                    if (customer.latitude && customer.longitude) {
                        var marker = new AMap.Marker({
                            position: new AMap.LngLat(customer.longitude, customer.latitude),
                            title: `${customer.name} - ${customer.address}`
                        });
                        marker.setMap(map);
                        marker.on('click',function() {
                                // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
                                var infoContent = `
                                    <div style="padding: 12px; min-width: 180px;">
                                        <h4 style="margin:0 0 5px 0; color:#1890ff;">${customer.name}</h4>
                                        <p style="margin:5px 0; color:#666; font-size:13px;">${customer.address}</p >
                                        <button onclick="navigateToMap(${customer.longitude}, ${customer.latitude}, '${customer.name}')" 
                                                style="width:100%; margin-top:8px; padding:8px; background:#1890ff; color:white; border:none; border-radius:4px; font-size:14px; cursor:pointer;">
                                            ğŸš— å»è¿™é‡Œ
                                        </button>
                                    </div>
                                `;
                                var infoWindow = new AMap.InfoWindow({
                                    content: infoContent,
                                    offset: new AMap.Pixel(0, -30)
                                });
                                infoWindow.open(map, [customer.longitude, customer.latitude]);
                            });
                        }
                    });
                })
                .catch((e) => {
                    console.error(e); //åŠ è½½é”™è¯¯æç¤º
                });
        })

    // ========== å¯¼èˆªåŠŸèƒ½ï¼šè‡ªåŠ¨è¯†åˆ«è®¾å¤‡ ==========
    function navigateToMap(lng, lat, name) {
        // æç¤ºå¼¹çª—
        alert('æ­£åœ¨æ‰“å¼€åœ°å›¾ï¼Œå¦‚è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œè¯·ç‚¹å‡»åœ°å€æ å…è®¸å¼¹çª—...');

        const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
        const encodedName = encodeURIComponent(name);
        
        if (isMobile) {
            // æ‰‹æœºç«¯ï¼šç³»ç»Ÿé€‰æ‹©å™¨
            window.location.href = `geo:${lat},${lng}?q=${lat},${lng}(${encodedName})`;
            setTimeout(() => {
                window.open(`https://uri.amap.com/marker?position=${lng},${lat}&name=${encodedName}`, '_blank');
            }, 1000);
        } else {
            // ç”µè„‘ç«¯ï¼šå¼¹ä¸ªç®€å•é€‰æ‹©
            const choice = confirm(`ç”¨å“ªä¸ªåœ°å›¾æŸ¥çœ‹ ${name}ï¼Ÿ\nç¡®å®š=é«˜å¾·åœ°å›¾ï¼Œå–æ¶ˆ=ç™¾åº¦åœ°å›¾`);
            if (choice) {
                window.open(`https://uri.amap.com/marker?position=${lng},${lat}&name=${encodedName}`, '_blank');
            } else {
                window.open(`https://map.baidu.com/?latlng=${lat},${lng}&title=${encodedName}`, '_blank');
            }
        }
    }



</script>
    
    <a href="{{ url_for('map.list_customers') }}" class="btn btn-primary">ç®¡ç†å®¢æˆ·åˆ—è¡¨</a>
{% endblock %}